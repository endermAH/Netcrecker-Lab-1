#!/bin/bash

./ter_log.sh apply

jenkins_ip="178.128.139.237"
echo Jenkins ip - $jenkins_ip
psql_ip=$(./parse_ip.py psql)
echo Postgresql ip - $psql_ip
liferay_ip="178.128.142.117"

rm ~/.ssh/known_hosts

echo Connecting to root@$jenkins_ip - ssh-keygen

ssh root@$jenkins_ip "echo '    StrictHostKeyChecking no' >> /etc/ssh/ssh_config"
ssh root@$jenkins_ip "ssh-keygen -t rsa -f ~/.ssh/id_rsa -q -N ''"
scp root@$jenkins_ip:~/.ssh/id_rsa.pub ./key
ssh root@$jenkins_ip "cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys"
KEY=$(cat ./key)
ssh root@$psql_ip "echo $KEY >> ~/.ssh/authorized_keys"
ssh root@$liferay_ip "echo $KEY >> ~/.ssh/authorized_keys"
rm ./key

echo [jenkins] > ../inventory.ini
echo 127.0.0.1 >> ../inventory.ini
echo [psql] >> ../inventory.ini
echo $psql_ip >> ../inventory.ini
echo [liferay] >> ../inventory.ini
echo $liferay_ip >> ../inventory.ini

ssh root@$jenkins_ip "git clone https://github.com/endermAH/Netcrecker-project.git"
ssh root@$jenkins_ip "rm ~/Netcrecker-project/inventory.ini"

scp ../inventory.ini root@$jenkins_ip:~/Netcrecker-project/
scp ~/liferay_files.zip root@$jenkins_ip:~/
ssh root@$jenkins_ip "unzip ~/liferay_files.zip -d ~/"

ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/jenkins-vps-playbook.yml"
ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/psql-vps-playbook.yml"
ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/liferay-vps-playbook.yml"
# ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/jenkins_install.yml"
# ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/configure_jenkins.yml"

ssh root@$jenkins_ip "curl http://127.0.0.1:8080/jenkins/job/netcracker/build?token=START_PIPELINE "
