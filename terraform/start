#!/bin/bash

# ./ter_log.sh apply

jenkins_ip=$(./parse_ip.py jenkins)
echo Jenkins ip - $jenkins_ip
psql_ip=$(./parse_ip.py psql)
echo Postgresql ip - $psql_ip
liferay_ip="178.128.142.117"

# rm ~/.ssh/known_hosts
#
# echo Connecting to root@$jenkins_ip - ssh-keygen
# ssh root@$jenkins_ip "ssh-keygen"
# scp root@$jenkins_ip:~/.ssh/id_rsa.pub ./key
# ssh root@$jenkins_ip "cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys"
# KEY=$(cat ./key)
# ssh root@$psql_ip "echo $KEY >> ~/.ssh/authorized_keys"
# ssh root@$liferay_ip "echo $KEY >> ~/.ssh/authorized_keys"
# rm ./key

# echo [jenkins] > ../inventory.ini
# echo 127.0.0.1 >> ../inventory.ini
# echo [psql] >> ../inventory.ini
# echo $psql_ip >> ../inventory.ini
# echo [liferay] >> ../inventory.ini
# echo $liferay_ip >> ../inventory.ini
#
# git add ../inventory.ini
# git commit -m "SCRIPT: New inventory"
# git push

ssh root@$jenkins_ip "git clone https://github.com/endermAH/Netcrecker-project.git"
ssh root@$jenkins_ip "cd Netcrecker-project && git checkout terraform"

ssh root@$jenkins_ip "apt update && sudo apt upgrade -y"
ssh root@$jenkins_ip "apt-get install -y  python-pip python-yaml python-jinja2 python-httplib2 python-paramiko python-pkg-resources ansible unzip"

ssh root@$jenkins_ip "ssh root@$psql_ip \"echo test\""
ssh root@$jenkins_ip "ssh root@$liferay_ip \"echo test\""

scp ~/liferay_files.zip root@$jenkins_ip:~/
ssh root@$jenkins_ip "unzip ~/liferay_files.zip -d ~/"

ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/jenkins-vps-playbook.yml"
ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/psql-vps-playbook.yml"
ssh root@$jenkins_ip "ansible-playbook -i ~/Netcrecker-project/inventory.ini ~/Netcrecker-project/liferay-vps-playbook.yml"
